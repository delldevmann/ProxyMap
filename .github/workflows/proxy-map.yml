name: Generate Proxy Map

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install folium requests matplotlib pandas

      - name: Generate proxy map
        run: |
          python3 << 'EOF'
          import requests, folium, pandas as pd, matplotlib.pyplot as plt
          from folium.plugins import Fullscreen, MiniMap, FloatImage
          import os

          # Fetch proxy data
          url = 'https://raw.githubusercontent.com/delldevmann/proxy-scraper/main/results/summary_latest.json'
          try:
              data = requests.get(url, timeout=30).json()
          except Exception as e:
              print(f"Error fetching data: {e}")
              exit(1)

          # Process proxy data
          proxies = []
          for group in data.values():
              for proxy in group.get("sample_proxies", {}).values():
                  loc = proxy.get("location", {})
                  if loc.get("lat") and loc.get("lon"):
                      proxies.append({
                          "ip": proxy["ip"],
                          "latency": proxy.get("latency_ms", 9999),
                          "anonymity": proxy.get("anonymity", "Unknown"),
                          "lat": loc["lat"],
                          "lon": loc["lon"],
                          "city": loc.get("city", "Unknown"),
                          "country": loc.get("country", "Unknown"),
                          "code": loc.get("countryCode", "xx"),
                          "isp": loc.get("isp", "N/A")
                      })

          if not proxies:
              print("No proxy data found")
              exit(1)

          df = pd.DataFrame(proxies)
          lat, lon = df["lat"].mean(), df["lon"].mean()

          # Create the map
          m = folium.Map(
              location=[lat, lon], 
              zoom_start=2, 
              tiles="CartoDB positron", 
              control_scale=True
          )
          
          # Add plugins
          Fullscreen().add_to(m)
          MiniMap(toggle_display=True).add_to(m)

          # Add markers for each proxy
          for _, row in df.iterrows():
              color = 'green' if row["latency"] < 1000 else 'orange' if row["latency"] < 2000 else 'red'
              flag = f"https://flagcdn.com/24x18/{row['code'].lower()}.png"
              
              popup = f"""
              <div style='font-family:Arial; font-size:13px; width:250px'>
                <img src='{flag}' style='vertical-align:middle' onerror="this.style.display='none'"> 
                <b>{row['country']}</b><br>
                <b>IP:</b> {row['ip']}<br>
                <b>City:</b> {row['city']}<br>
                <b>ISP:</b> {row['isp']}<br>
                <b>Latency:</b> {row['latency']} ms<br>
                <b>Anonymity:</b> {row['anonymity']}
              </div>
              """
              
              folium.CircleMarker(
                  location=[row["lat"], row["lon"]],
                  radius=6,
                  color=color,
                  fill=True,
                  fill_opacity=0.9,
                  popup=folium.Popup(popup, max_width=300),
                  tooltip=f"{row['ip']} ({row['country']})"
              ).add_to(m)

          # Create country distribution chart with better styling
          top_countries = df["country"].value_counts().nlargest(8)
          plt.figure(figsize=(8, 5))
          plt.style.use('seaborn-v0_8')
          
          colors = plt.cm.Set3(range(len(top_countries)))
          bars = plt.barh(range(len(top_countries)), top_countries.values, color=colors)
          
          plt.yticks(range(len(top_countries)), top_countries.index)
          plt.xlabel("Number of Proxies", fontsize=11, fontweight='bold')
          plt.title("Top Countries by Proxy Count", fontsize=12, fontweight='bold', pad=15)
          plt.grid(axis='x', alpha=0.3, linestyle='--')
          
          # Add value labels on bars
          for i, (country, count) in enumerate(top_countries.items()):
              plt.text(count + 0.5, i, str(count), va='center', ha='left', fontweight='bold', fontsize=9)
          
          # Style improvements
          plt.gca().spines['top'].set_visible(False)
          plt.gca().spines['right'].set_visible(False)
          plt.gca().spines['left'].set_visible(False)
          plt.tight_layout()

          # Create output directory
          os.makedirs("public", exist_ok=True)
          
          # Save chart with white background
          plt.savefig("public/country_chart.png", dpi=120, bbox_inches='tight', 
                     facecolor='white', edgecolor='none')
          plt.close()

          # Add stats info box
          stats_html = f"""
          <div style="position: fixed; 
                      top: 10px; left: 10px; width: 200px; 
                      background-color: rgba(255,255,255,0.95); 
                      border: 2px solid #333; border-radius: 8px;
                      z-index: 9999; font-size: 12px; padding: 12px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
          <h4 style="margin: 0 0 8px 0; color: #333;">ðŸ“Š Proxy Statistics</h4>
          <div style="color: #555;">
            <strong>Total Proxies:</strong> {len(proxies)}<br>
            <strong>Countries:</strong> {df['country'].nunique()}<br>
            <strong>Avg Latency:</strong> {df['latency'].mean():.0f}ms<br>
            <strong>Last Update:</strong> Now
          </div>
          </div>
          """
          
          # Add improved legend
          legend_html = """
          <div style="position: fixed; 
                      top: 10px; right: 10px; width: 140px; 
                      background-color: rgba(255,255,255,0.95); 
                      border: 2px solid #333; border-radius: 8px;
                      z-index: 9999; font-size: 12px; padding: 12px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
          <h4 style="margin: 0 0 8px 0; color: #333;">ðŸš¦ Latency</h4>
          <div style="display: flex; align-items: center; margin: 4px 0;">
            <div style="width: 12px; height: 12px; background-color: green; border-radius: 50%; margin-right: 8px;"></div>
            <span style="color: #555;">< 1000ms</span>
          </div>
          <div style="display: flex; align-items: center; margin: 4px 0;">
            <div style="width: 12px; height: 12px; background-color: orange; border-radius: 50%; margin-right: 8px;"></div>
            <span style="color: #555;">1000-2000ms</span>
          </div>
          <div style="display: flex; align-items: center; margin: 4px 0;">
            <div style="width: 12px; height: 12px; background-color: red; border-radius: 50%; margin-right: 8px;"></div>
            <span style="color: #555;">> 2000ms</span>
          </div>
          </div>
          """
          
          # Add chart as floating image - positioned better
          FloatImage("public/country_chart.png", bottom=15, right=15).add_to(m)
          
          # Add both info boxes
          m.get_root().html.add_child(folium.Element(stats_html))
          m.get_root().html.add_child(folium.Element(legend_html))
          
          # Save map
          m.save("public/index.html")
          
          print(f"Generated map with {len(proxies)} proxies from {df['country'].nunique()} countries")
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build-and-deploy
    runs-on: ubuntu-22.04
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      pages: write
      id-token: write
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
